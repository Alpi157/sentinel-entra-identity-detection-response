# Case Study: INC-0001 — Entra ID Identity Attack Chain (Offline Sentinel/SOAR Lab)

**Incident ID:** INC-0001  
**Environment:** Microsoft Entra ID telemetry (SigninLogs + AuditLogs) → Sentinel-style detections (KQL) → Workbook pivots → SOAR enrichment/ticketing → AI triage summary (human-in-the-loop)  
**Report version:** 1.0  
**Time zone:** UTC  
**Prepared by:** Alpar Arman  
**Status:** Closed (lab simulation)

---

## 1) Executive Summary

This case study simulates a **high-risk identity incident** involving suspicious Entra ID authentication activity and follow-on identity changes consistent with **account compromise + persistence attempts**.

**Key finding:** A user account (`standard.user1@lab.local`) experienced **multiple failed sign-ins followed by a successful sign-in** from a single external IP in **RU**, consistent with brute force/password spraying behavior. Shortly after, **OAuth consent** was granted to an application and **MFA/security info was changed**, increasing persistence risk.

**Actions taken (lab):**
- Generated Sentinel-style alerts (DET-01..DET-07) from sample Entra logs
- Created an investigation bundle (JSON) and an analyst ticket (GitHub Issue) via SOAR-safe workflow
- Produced an AI triage summary with confidence scoring (**no autonomous containment**)

**Business impact (simulated):** Potential unauthorized access to Microsoft 365 apps and tenant resources through compromised identity and consent-based persistence.

> This report format follows common incident response lifecycle guidance (Preparation → Detection/Analysis → Containment/Eradication/Recovery → Post-Incident/Lessons Learned). :contentReference[oaicite:2]{index=2}

---

## 2) Incident Scope & Assets

### Affected identities (entities)
- `standard.user1@lab.local` (primary victim account)
- `sec.analyst@lab.local` (separate anomaly: new country sign-ins)
- `standard.user2@lab.local` (legacy auth sign-in)
- `it.admin@lab.local` (initiator of privileged changes in AuditLogs)

### Suspicious infrastructure
- `203.0.113.77` (RU) — primary suspicious IP linked to failures→success pattern
- `198.51.100.44` (RU) — new-country sign-ins for `sec.analyst@lab.local`

### Cloud applications observed
- Azure Portal, Microsoft 365 Portal, SharePoint Online (from SigninLogs evidence)

---

## 3) Detection Summary (What fired & why it matters)

Alerts generated by the offline detection runner:

- **DET-01 (High):** Multiple failures followed by success from same IP  
  - Evidence indicates a classic authentication abuse pattern consistent with **Brute Force / Password Spraying (T1110 / T1110.003)** and potential **Valid Accounts (T1078)** once success occurs. :contentReference[oaicite:3]{index=3}

- **DET-02 (Medium):** Legacy Authentication sign-in detected  
  - Legacy auth is a common risk because it can bypass modern controls and complicates conditional access enforcement.

- **DET-03 (Medium):** New country sign-in (baseline vs recent)  
  - A user (`sec.analyst@lab.local`) signed in successfully from **RU** even though baseline country was **CA**, indicating suspicious travel/impossible-travel style anomaly.

- **DET-04 (High):** Privileged role assignment / membership change  
  - Privileged role operations are high-impact and often used for escalation.

- **DET-05 (High):** App/service principal credentials added/updated  
  - Service principal secrets/credentials can be used for persistence and automated access.

- **DET-06 (Medium):** OAuth consent granted to application  
  - In cloud environments, OAuth app integrations can be abused for long-lived access. This aligns with cloud application integration abuse patterns (OAuth). :contentReference[oaicite:4]{index=4}

- **DET-07 (High):** MFA/security info changed  
  - Changes to authentication methods can enable persistence and reduce the victim’s ability to regain control, mapping to **Modify Authentication Process (T1556)** in concept. :contentReference[oaicite:5]{index=5}

> Note: Your console output for DET-07 appears truncated in the pasted snippet; the authoritative alert record is in `data/demo-output/alerts.json`.

---

## 4) Timeline of Events (UTC)

| Time (UTC) | Alert / Event | Entity | Key detail |
|---|---|---|---|
| 2026-01-23 02:10 | DET-02 Legacy Auth sign-in | standard.user2 | Successful legacy authentication from CA IP |
| 2026-01-23 04:10 → 04:30 | DET-03 New Country | sec.analyst | 2 successful sign-ins from RU (baseline CA) |
| 2026-01-23 08:10 → 08:30 | DET-01 Failures→Success | standard.user1 | 15 failures then success from RU IP `203.0.113.77` |
| 2026-01-23 09:10 | DET-04 Privileged role change | it.admin | “Add member to role” (Global Administrator) |
| 2026-01-23 10:10 | DET-05 App credentials | it.admin | Service principal credentials added (`Contoso-App`) |
| 2026-01-23 11:10 | DET-06 OAuth consent | standard.user1 | “Consent to application” (`Suspicious-OAuth-App`) |
| ~2026-01-23 12:10 | DET-07 MFA change | standard.user1 | Security info/auth method updated (see alerts.json) |

---

## 5) Investigation & Analysis (How we triaged)

### 5.1 Analyst workflow (Workbook-first)
Using the “Identity Investigations” workbook view:
- Pivoted on **Account** (`standard.user1@lab.local`) and **IP** (`203.0.113.77`)
- Reviewed sign-in trend, failure/success ratio, apps used, and country
- Pivoted to **AuditLogs** around the post-authentication window to identify follow-on actions:
  - OAuth consent grants
  - MFA/security info changes
  - privileged role operations and app credential additions

### 5.2 Key evidence (from alerts output)

**DET-01 evidence:**  
- First failures begin **2026-01-23T08:10:00Z**
- Success occurs **2026-01-23T08:30:00Z**
- IP: **203.0.113.77**
- Country: **RU**
- Apps observed during failures/success: SharePoint Online, Microsoft 365 Portal, Azure Portal

Interpretation:
- Pattern is consistent with credential guessing attempts culminating in valid access, mapping to **Password Spraying/Brute Force** (T1110/T1110.003) and subsequent **Valid Accounts** usage (T1078). :contentReference[oaicite:6]{index=6}

**DET-06 evidence:**  
- “Consent to application” for `Suspicious-OAuth-App` on **2026-01-23T11:10:00Z**  
Interpretation:
- OAuth consent can enable app-based access and token-based persistence in cloud services. :contentReference[oaicite:7]{index=7}

**DET-07 evidence (from alerts.json):**  
- MFA/security info updated post-compromise  
Interpretation:
- Authentication process modification increases the probability that access could persist even if the user resets password, aligning conceptually to “modify authentication process” behavior. :contentReference[oaicite:8]{index=8}

### 5.3 Assessment: likely scenario
**Most likely hypothesis (lab narrative):**
1) Attacker attempts multiple sign-ins from a single RU IP → eventually succeeds (DET-01)  
2) After successful access, attacker (or compromised user session) grants OAuth consent (DET-06)  
3) MFA/security info updated (DET-07), potentially to lock in persistence  
4) Separate high-impact operations exist (DET-04/DET-05) indicating either:
   - a parallel admin misuse scenario, or
   - a broader identity compromise involving privileged operations

**Confidence:** Medium–High (based on the strong failures→success pattern + post-auth changes).  
(For real production, we’d confirm by inspecting risk events, device IDs, user agents, token activity, and correlating admin changes to approved change tickets.)

---

## 6) Response Actions (What we automated vs what requires approval)

This lab intentionally uses **safe SOAR** automation (no autonomous containment).

### 6.1 Automated actions (PB-01 Enrich & Ticket)
- Generated an **investigation bundle JSON**:
  - `enrichment-graph/sample-output/investigation-bundle.sample.json`
- Generated a GitHub dispatch payload:
  - `enrichment-graph/sample-output/github-dispatch-payload.json`
- Created an analyst ticket automatically (GitHub Issue):
  - `[SOC] High — DET-01 Multiple failures followed by success from same IP #1`
  - Ticket includes entities, detections, enrichment highlights, and next steps

### 6.2 Manual-only actions (PB-02 Manual Containment)
**No containment was executed automatically.**  
If this were real production, the following would require explicit approval:
- disable user sign-in / revoke sessions
- revoke OAuth consent / remove app grants
- remove privileged role memberships
- rotate/disable service principal credentials
- reset MFA/security info

This aligns with best practice to balance speed with governance and reduce blast-radius risk from automation errors. :contentReference[oaicite:9]{index=9}

---

## 7) Business Impact Assessment (Simulated)

Potential impacts if real:
- Unauthorized access to M365 resources via compromised user identity
- Long-lived access via OAuth app consent and refresh tokens
- Privileged escalation risk via role membership changes
- Persistence via service principal credential creation

Observed in lab:
- No verified data exfiltration (not modeled in sample logs)
- Impact assessed based on identity control-plane signals

---

## 8) Recommendations (Controls + detection tuning)

### Immediate containment recommendations (if real)
1) Revoke active sessions and require password reset for `standard.user1`
2) Review and revoke suspicious OAuth consent grants (especially broad scopes)
3) Validate MFA/security info changes and revert unauthorized changes
4) Audit privileged role assignments and remove unauthorized memberships
5) Rotate any newly created application secrets and review service principals

### Preventive controls (strategic)
- Enforce MFA and risk-based sign-in policies for all users
- Block legacy authentication where possible
- Restrict user OAuth consent (admin approval for high-risk scopes)
- Implement least privilege and privileged access workflows
- Monitor and alert on privileged role changes + app credential operations

### Detection tuning
- DET-01: tune failure threshold by tenant size; suppress known corporate egress IPs
- DET-03: tune baseline window and add allowlist for expected travel
- DET-04/05/06/07: add allowlist for approved automation accounts and change windows

---

## 9) Lessons Learned (Post-incident activity)

Consistent with incident response guidance, capture improvements after closure: :contentReference[oaicite:10]{index=10}

- **Process:** clear handoff between detections → workbook pivots → ticketing → manual containment
- **Engineering:** stable JSON “investigation bundle” schema makes enrichment and AI summaries reusable
- **Governance:** AI summarizer produces rationale + confidence; containment remains manual-only

---

## 10) Artifacts & Repro Steps (Recruiter-friendly)

### Key artifacts
- Alerts output: `data/demo-output/alerts.json`
- Incident contexts: `data/demo-output/incident_contexts/*.json`
- Investigation bundle: `enrichment-graph/sample-output/investigation-bundle.sample.json`
- Dispatch payload: `enrichment-graph/sample-output/github-dispatch-payload.json`
- AI triage summary: `ai-triage-summarizer/sample-output/triage-summary.sample.md`
- Ticket: GitHub Issue `#1`

### One-command reproduction (offline lab)
```powershell
python tools\local-kql\generate_sample_logs.py
python tools\local-kql\run_detections.py
python enrichment-graph\src\main.py
python enrichment-graph\src\make_github_dispatch_payload.py
python ai-triage-summarizer\src\summarize.py
